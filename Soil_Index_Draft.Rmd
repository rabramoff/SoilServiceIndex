---
title: "Soil_Index_Draft"
author: "Rose Abramoff"
date: "9/25/2017"
output: html_document
---
#Looking for gridded products to classify variables into land use type, soil type, and by climate (MAT, MAP)
##Land use type
```
MODIS IGBP land cover map (Liu et al. 2015 NCC re-sampled to 0.25◦ by dominant land use to calculate ABC per biome) 
Friedl, M. A. et al. MODIS Collection 5 global land cover: Algorithm refinements and characterization of new datasets. Remote Sens. Environ. 114, 168–182 (2010).
maybe here? need to look at Friedl paper some more: https://modis.gsfc.nasa.gov/data/
```
##Soil type
```
Soilgrids (used in Crowther et al. 2016 Nature meta-analysis as in Koven et al. 2015 Phil. Trans. R. Soc. A following the procedure in Crowther et al. 2015 Nature which seems to mean simply taking the co-located or nearest 1km resolution grid)
http://www.isric.org/explore/soilgrids
ftp://ftp.soilgrids.org/data/recent/ <- I'm having trouble connecting to this with ftp soilgrids.org
```
##Climate
```
Worldclim ("Bioclim" in Crowther et al. 2016 Nature following the procedure in Crowther et al. 2015 Nature, which seems to mean simply taking the co-located or nearest 1km resolution grid)
http://www.worldclim.org/bioclim
http://worldclim.org/version2 #can get down to 1km spatial resolution
download some 30 minute (1km resolution) data
```
#Load Workspace
```{r}
load(file="SoilIndex.Rdata")
```

#Preliminary Index from 0-1
```{r}
EnterYourSOCValue <- 1000 #in gC/dm3 - same as kg/m3
EnterYourNminValue <- 30 #in g/m2/yr for OA horizons
EnterYourClayValue <- 60 #in %
SOCWeight <- 1
NminWeight <- 0.5
ClayWeight <- 0.5

W.Index(EnterYourSOCValue,EnterYourNminValue,EnterYourClayValue,SOCWeight,NminWeight,ClayWeight)
```

#Other scripts
#Make plots
```{r}
library(ggplot2)

#pdf(file="/Users/rzabramoff/Dropbox (Climate)/External Collaborations/ISCN/density_plots.pdf")
#SOC plot
ggplot(sf, aes(carbon.1m, fill=LandUseType)) +
  stat_density(position="identity", alpha=0.7) +
  xlab("Soil C (kgC/m2) - 1m") +
  theme(text = element_text(size=20))

#N min plot
ggplot(nf, aes(NminNum, fill=LandUseType)) +
  stat_density(position="identity", alpha=0.7) +
  xlim(-10,60) +
  xlab("N mineralization (g/m2/y) - OA horizon") +
  theme(text = element_text(size=20))

#Clay plot
ggplot(sf, aes(clay.1m, fill=LandUseType)) +
  stat_density(position="identity", alpha=0.7) +
  xlab("Clay content (%) - 1m") +
  theme(text = element_text(size=20))
#dev.off()
```

#Map of sites - find sites that overlap in the two datasets
```{r}
library(ggplot2)
library(ggmap)
library(maps)
library(mapdata)
w2hr <- map_data("world2Hires")
wrld <- map_data("world")
usa <- map_data("usa")
sf$lat <- as.numeric(sf$latitude)
sf$long <- as.numeric(sf$longitude)
nf$lat <- as.numeric(as.character(nf$Latitude))
nf$long <- as.numeric(as.character(nf$Longitude))
```

#Global map
```{r}
gg1 <- ggplot() + 
  geom_polygon(data = wrld, aes(x=long, y = lat, group = group), fill = NA, color = "black") + 
  coord_fixed(1.3)
#pdf(file="/Users/rzabramoff/Dropbox (Climate)/External Collaborations/ISCN/sites_map_world.pdf")
gg1 + 
  geom_point(data = sf, aes(x = long, y = lat), color = "red", size = 1) +
  geom_point(data = nf, aes(x = long, y = lat), color = "blue", size = 1)
#dev.off()
```

#USA
```{r}
gg2 <- ggplot() + 
  geom_polygon(data = usa, aes(x=long, y = lat, group = group), fill = NA, color = "black") + 
  coord_fixed(1.3) +
  ylim(25,50) +
  xlim(-130,-65)
#pdf(file="/Users/rzabramoff/Dropbox (Climate)/External Collaborations/ISCN/sites_map_usa.pdf")
gg2 + 
  geom_point(data = sf, aes(x = long, y = lat), color = "red", size = 3) +
  geom_point(data = nf, aes(x = long, y = lat), color = "blue", size = 3)
#dev.off()
```

#Index
```{r}
##Redo index function for three land types only
SOCnums <- sf[sf$LandUseType==c("forest","grass","undisturbed"),]$carbon.1m
SOCnums <- SOCnums[!is.na(SOCnums)] #remove NAs
NminNums <- as.numeric(as.character(nf[nf$LandUseType==c("forest","grass","undisturbed"),]$Nmin_g_m2_yr_OA_mean))
Nnums <- NminNums[!is.na(NminNums)] #remove NAs
Nnums <- Nnums[Nnums < 400 & Nnums > -200] #remove 2 outliers
Claynums <- sf[sf$LandUseType==c("forest","grass","undisturbed"),]$clay.1m
Claynums <- Claynums[!is.na(Claynums)] #remove NAs

range01 <- function(x){(x-min(x))/(max(x)-min(x))}
rangeSOC <- function(x){(x-min(SOCnums))/(max(SOCnums)-min(SOCnums))}
rangeNmin <- function(x){(x-min(Nnums))/(max(Nnums)-min(Nnums))}
rangeClay <- function(x){(x-min(Claynums))/(max(Claynums)-min(Claynums))}

W.Index <- function(s,n,c,ws,wn,wc){
SOCindex <- rangeSOC(EnterYourSOCValue)
Nindex <- rangeNmin(EnterYourNminValue)
Clayindex <- rangeClay(EnterYourClayValue)
windex <- (SOCindex*ws + Nindex*wn + Clayindex*wc)/3
return(windex)
}

socs = tapply(sf$carbon.1m, sf$LandUseType, FUN=mean)
nmins = tapply(nf$NminNum, nf$LandUseType, FUN=mean, na.rm=T)
clays = tapply(sf$clay.1m, sf$LandUseType, FUN=mean, na.rm=T)
EnterYourSOCValue <- socs[c("forest","grass","undisturbed")] #kgC/m2 to 1m
EnterYourNminValue <- nmins[c("forest","grass","undisturbed")] #in g/m2/yr for OA horizons
EnterYourClayValue <- clays[c("forest","grass","undisturbed")] #in %
SOCWeight <- 1
NminWeight <- 1
ClayWeight <- 1

Equalweight <- W.Index(EnterYourSOCValue,EnterYourNminValue,EnterYourClayValue,SOCWeight,NminWeight,ClayWeight)

SOCWeight <- 1.5
NminWeight <- 0.5
ClayWeight <- 0.5

SOCweighted <- W.Index(EnterYourSOCValue,EnterYourNminValue,EnterYourClayValue,SOCWeight,NminWeight,ClayWeight)

SOCWeight <- 0.5
NminWeight <- 0.5
ClayWeight <- 1.5

Clayweighted <- W.Index(EnterYourSOCValue,EnterYourNminValue,EnterYourClayValue,SOCWeight,NminWeight,ClayWeight)

SOCWeight <- 0.5
NminWeight <- 1.5
ClayWeight <- 0.5

Nminweighted <- W.Index(EnterYourSOCValue,EnterYourNminValue,EnterYourClayValue,SOCWeight,NminWeight,ClayWeight)

#pdf(file="/Users/rzabramoff/Dropbox (Climate)/External Collaborations/ISCN/figures/mean_index_by_landuse_barplots.pdf")
tab = rbind(Equalweight,SOCweighted)
barplot(tab, beside = T, legend=T, legend.text = c("Equal Weight","SOC Weighted 3x"))

tab = rbind(Equalweight,SOCweighted, Nminweighted, Clayweighted)
barplot(tab, beside = T, col= c(1,"brown","dark green","gray"), legend=T, legend.text = c("Equal Weight","SOC Weighted 3x","Nmin Weighted 3x","Clay Weighted 3x"))
#dev.off()
```

##Index Function
```{r}
SOCnums <- sf$carbon.1m
SOCnums <- SOCnums[!is.na(SOCnums)] #remove NAs
nf$NminNum <- as.numeric(as.character(nf$Nmin_g_m2_yr_OA_mean))
Nnums <- nf$NminNum[!is.na(nf$NminNum)] #remove NAs
Nnums <- Nnums[Nnums < 400 & Nnums > -200] #remove 2 outliers
Claynums <- sf$clay.1m
Claynums <- Claynums[!is.na(Claynums)] #remove NAs

range01 <- function(x){(x-min(x))/(max(x)-min(x))}
rangeSOC <- function(x){(x-min(SOCnums))/(max(SOCnums)-min(SOCnums))}
rangeNmin <- function(x){(x-min(Nnums))/(max(Nnums)-min(Nnums))}
rangeClay <- function(x){(x-min(Claynums))/(max(Claynums)-min(Claynums))}

W.Index <- function(s,n,c,ws,wn,wc){
SOCindex <- rangeSOC(EnterYourSOCValue)
Nindex <- rangeNmin(EnterYourNminValue)
Clayindex <- rangeClay(EnterYourClayValue)
windex <- (SOCindex*ws + Nindex*wn + Clayindex*wc)/3
return(windex)
}
```

